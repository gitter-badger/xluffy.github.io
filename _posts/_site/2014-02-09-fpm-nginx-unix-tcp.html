<h3 id="vn_">Vấn đề:</h3>

<p>Trước đây có một thời gian mình dùng ab để benchmark ứng dụng Web chạy Apache +FastCGI thì xảy ra tình huốngkhi tăng số lượng request (-c) lên cao thì thấy bắn ra rất nhiều các error dạng như sau:</p>

<p><code>connect() to unix:/var/run/php5-fpm.sock failed or **apr_socket_recv: Connection reset by peer (104)**</code></p>

<p>Phải nói là lúc đó mình đã mất 2 ngày để search về vấn đề này nhưng vẫn không có tí kết quả nào là tại sao lại có lỗi như vậy.</p>

<p>Gần đây nhân làm việc nhiều hơn với Nginx, PHP-FPM và như bài trước nói về cách biên dịch và sử dụng PHP với Web service mình mới hiểu ra vấn đề và viết sơ lại theo <strong>suy đoán</strong> của mình</p>

<p>Như trong bài trước mình có nói việc sử dụng FastCGI để quản lý các tiến trình PHP. Tức là giữa web server và FastCGI server sẽ phải có một phương thức để kết nối. Cụ thể ở đây hoặc là Unix socket hoặc là TCP. Lỗi trên theo ngu ý của mình thì xảy ra khi FastCGI client (Apache) gửi <strong>quá nhiều</strong> connection tới FastCGI Server, vượt quá một con số mặc định cho phép nào đó của Kernel Linux.</p>

<p>Unix socket thì mình chưa rõ là tham số nào quy định số lượng connection này, TCP thì có vẻ là các tham số trong tập tin <code>sysctl.conf</code> quản lý.</p>

<p>Mình đang tìm hiểu xem nên sử dụng Unix socket hay TCP trong mô hình Nginx, PHP-FPM, lợi điểm của từng phương pháp.</p>

<p>Hiện tại nếu sử dụng TCP thì theo ý mình cần tweak các tham số trong <code>synctl.conf</code> thì lỗi trên khả năng sẽ giảm hoặc không xảy ra nữa.</p>